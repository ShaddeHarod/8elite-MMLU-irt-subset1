#!/system/bin/sh
# run_adb_model.sh
# 两阶段功耗测试框架：基线测试 + 实际测试

# set -e

mkdir -p result

# 配置变量
TEST_SCRIPT="read_all_subjects_prompts.sh"
OUTPUT_FILE="output.txt"
POWER_LOG_FILE="power_consumption.log"
FINAL_REPORT_FILE="result/FINAL_POWER_REPORT.json"

# 日志函数
log_info() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] INFO: $1" >> "$POWER_LOG_FILE"
    echo "[$timestamp] INFO: $1" >&2
}

log_error() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] ERROR: $1" >> "$POWER_LOG_FILE"
    echo "[$timestamp] ERROR: $1" >&2
}

# 环境控制
setup_test_environment() {
    log_info "设置测试环境..."

    # 断开充电连接
    cmd battery unplug >/dev/null 2>&1 || true

    # 设置屏幕亮度（如果需要保持屏幕开启）
    # settings put system screen_brightness 100 >/dev/null 2>&1 || true

    # 禁用网络连接以减少干扰（可选）
    # svc wifi disable >/dev/null 2>&1 || true
    # svc data disable >/dev/null 2>&1 || true

    log_info "测试环境设置完成"
}

# 恢复环境设置
restore_environment() {
    log_info "恢复环境设置..."

    # 恢复充电连接
    cmd battery reset >/dev/null 2>&1 || true

    # 重置电池统计
    dumpsys batterystats --reset >/dev/null 2>&1 || true

    log_info "环境恢复完成"
}

# 获取batterystats功耗数据
get_power_consumption() {
    local start_time=$1
    local end_time=$2
    local test_name=$3

    log_info "获取 $test_name 的功耗数据..."

    # 获取电池统计
    local bs_output
    bs_output=$(dumpsys batterystats --checkin 2>/dev/null || echo "")

    if [ -z "$bs_output" ]; then
        log_error "无法获取电池统计数据"
        echo "-1.0"
        return 1
    fi

    # 尝试多个UID，获取总功耗
    local total_power=0
    local target_uids="2000 9999 0"

    for uid in $target_uids; do
        local uid_power
        uid_power=$(printf "%s\n" "$bs_output" \
          | awk -v uid="$uid" '
            /Estimated power use \(mAh\)/{in_section=1; next}
            in_section && /Uid/{
                for(i=1;i<=NF;i++) {
                    if($i == "Uid" && $(i+1) == uid) {
                        for(j=i+2;j<=NF;j++) {
                            if($j ~ /^[0-9.]+$/) {
                                print $j
                                break
                            }
                        }
                        break
                    }
                }
            }')

        # 验证提取的功耗值是否为有效数字
        if [ -n "$uid_power" ] && echo "$uid_power" | grep -qE '^[0-9]+\.?[0-9]*$'; then
            if [ "$(echo "$uid_power > 0" | bc 2>/dev/null || echo "0")" = "1" ]; then
                total_power=$(echo "$total_power $uid_power" | awk '{printf "%.3f", $1 + $2}')
                log_info "UID $uid 功耗: ${uid_power} mAh"
            fi
        fi
    done

    # 确保返回有效数值
    if [ -z "$total_power" ] || [ "$total_power" = "0" ]; then
        total_power="-1.0"
        log_info "$test_name 未检测到有效功耗数据，返回 -1.0"
    fi

    log_info "$test_name 总功耗: ${total_power} mAh"
    echo "$total_power"
}

# 分析内存数据（从read_all_subjects_prompts.sh移动过来）
analyze_memory_data() {
    local memory_log_file="$1"

    if [ ! -f "$memory_log_file" ] || [ ! -s "$memory_log_file" ]; then
        echo '{"memory_analysis": {"baseline_mem_kb": "NA", "baseline_mem_mb": "NA", "peak_mem_kb": "NA", "peak_mem_mb": "NA", "model_memory_kb": "NA", "model_memory_mb": "NA", "genie_active_samples": 0, "genie_inactive_samples": 0, "total_samples": 0}}'
        return
    fi

    # 提取genie_active=true时的system_mem_used值
    local genie_active_values
    genie_active_values=$(grep "genie_active:true" "$memory_log_file" | grep -o "system_mem_used:[0-9]*KB" | awk -F: '{gsub(/[^0-9]/, "", $2); if($2>0) print $2}')

    # 提取genie_active=false时的system_mem_used值
    local genie_inactive_values
    genie_inactive_values=$(grep "genie_active:false" "$memory_log_file" | grep -o "system_mem_used:[0-9]*KB" | awk -F: '{gsub(/[^0-9]/, "", $2); if($2>0) print $2}')

    # 计算基准内存（genie不活动时的最小值）
    local baseline_mem_kb="NA"
    local baseline_mem_mb="NA"
    local genie_inactive_samples=0

    if [ -n "$genie_inactive_values" ]; then
        baseline_mem_kb=$(echo "$genie_inactive_values" | sort -n | head -1)
        baseline_mem_mb=$(echo "$baseline_mem_kb 1024" | awk '{printf "%.1f", $1 / $2}')
        genie_inactive_samples=$(echo "$genie_inactive_values" | wc -l)
    fi

    # 计算峰值内存（genie活动时的最大值）
    local peak_mem_kb="NA"
    local peak_mem_mb="NA"
    local genie_active_samples=0

    if [ -n "$genie_active_values" ]; then
        peak_mem_kb=$(echo "$genie_active_values" | sort -nr | head -1)
        peak_mem_mb=$(echo "$peak_mem_kb 1024" | awk '{printf "%.1f", $1 / $2}')
        genie_active_samples=$(echo "$genie_active_values" | wc -l)
    fi

    # 计算模型内存占用
    local model_memory_kb="NA"
    local model_memory_mb="NA"

    if [ "$baseline_mem_kb" != "NA" ] && [ "$peak_mem_kb" != "NA" ]; then
        model_memory_kb=$((peak_mem_kb - baseline_mem_kb))
        model_memory_mb=$(echo "$model_memory_kb 1024" | awk '{printf "%.1f", $1 / $2}')
    fi

    # 计算总样本数
    local total_samples=$((genie_active_samples + genie_inactive_samples))

    # 生成JSON输出
    cat << EOF
{
  "memory_analysis": {
    "baseline_mem_kb": $baseline_mem_kb,
    "baseline_mem_mb": $baseline_mem_mb,
    "peak_mem_kb": $peak_mem_kb,
    "peak_mem_mb": $peak_mem_mb,
    "model_memory_kb": $model_memory_kb,
    "model_memory_mb": $model_memory_mb,
    "genie_active_samples": $genie_active_samples,
    "genie_inactive_samples": $genie_inactive_samples,
    "total_samples": $total_samples
  }
}
EOF
}

# Phase 1: 实际测试
run_actual_test() {
    log_info "=== Phase 1: 实际测试开始 ==="

    # 重置电池统计
    dumpsys batterystats --reset >/dev/null 2>&1
    local actual_start_time=$(date +%s%3N)

    # 运行实际的推理脚本
    log_info "开始运行推理测试..."
    if [ -f "$TEST_SCRIPT" ]; then
        sh "$TEST_SCRIPT" > "$OUTPUT_FILE" 2>&1
        local script_exit_code=$?
    else
        log_error "测试脚本 $TEST_SCRIPT 不存在"
        return 1
    fi

    local actual_end_time=$(date +%s%3N)
    local actual_power
    actual_power=$(get_power_consumption "$actual_start_time" "$actual_end_time" "实际测试")

    # 从输出中提取运行时间
    local runtime_ms=-1
    local runtime_s=-1
    if [ -f "$OUTPUT_FILE" ]; then
        runtime_ms=$(grep "TEST_RUNTIME_MS=" "$OUTPUT_FILE" | tail -1 | cut -d'=' -f2 | tr -d ' \n\r' || echo "-1")
        runtime_s=$(grep "TEST_RUNTIME_SECONDS=" "$OUTPUT_FILE" | tail -1 | cut -d'=' -f2 | tr -d ' \n\r' || echo "-1")

        # 验证提取的值
        if ! echo "$runtime_ms" | grep -qE '^[0-9]+$'; then
            runtime_ms="-1"
            log_info "运行时间(ms)数据无效，设置为 -1"
        fi

        if ! echo "$runtime_s" | grep -qE '^[0-9]+$'; then
            runtime_s="-1"
            log_info "运行时间(s)数据无效，设置为 -1"
        fi
    else
        log_info "输出文件不存在，运行时间设置为 -1"
    fi

    # 输出实际测试结果
    {
        echo "ACTUAL_TEST_DURATION_MS=$runtime_ms"
        echo "ACTUAL_TEST_DURATION_S=$runtime_s"
        echo "ACTUAL_POWER_MAH=$actual_power"
    } >> "$POWER_LOG_FILE"

    log_info "=== Phase 2: 实际测试完成 ==="
    echo "$actual_power" "$runtime_ms" "$runtime_s"
}

# Phase 2: 基线测试（空闲运行相同时间）
run_baseline_test() {
    local test_duration=$1

    log_info "=== Phase 2: 基线测试开始 ==="
    log_info "测试时长: ${test_duration} 秒"

    # 重置电池统计
    dumpsys batterystats --reset >/dev/null 2>&1
    local baseline_start_time=$(date +%s%3N)

    # 空闲运行相同时间
    log_info "开始空闲运行..."
    sleep "$test_duration"

    local baseline_end_time=$(date +%s%3N)
    local baseline_power
    baseline_power=$(get_power_consumption "$baseline_start_time" "$baseline_end_time" "基线测试")

    # 输出基线测试结果
    {
        echo "BASELINE_TEST_DURATION_MS=$((baseline_end_time - baseline_start_time))"
        echo "BASELINE_TEST_DURATION_S=$test_duration"
        echo "BASELINE_POWER_MAH=$baseline_power"
    } >> "$POWER_LOG_FILE"

    log_info "=== Phase 1: 基线测试完成 ==="
    echo "$baseline_power"
}



# 生成最终报告
generate_final_report() {
    local baseline_power=$1
    local actual_power=$2
    local runtime_ms=$3
    local runtime_s=$4

    log_info "生成最终报告..."

    # 计算genie实际功耗
    local genie_power="-1.0"
    local avg_power="-1.0"

    # 检查输入值是否有效（不是-1且是有效数字）
    local baseline_valid=false
    local actual_valid=false
    local runtime_valid=false

    if echo "$baseline_power" | grep -qE '^-?[0-9]+\.?[0-9]*$' && [ "$baseline_power" != "-1.0" ] && [ "$baseline_power" != "-1" ]; then
        baseline_valid=true
    fi

    if echo "$actual_power" | grep -qE '^-?[0-9]+\.?[0-9]*$' && [ "$actual_power" != "-1.0" ] && [ "$actual_power" != "-1" ]; then
        actual_valid=true
    fi

    if echo "$runtime_s" | grep -qE '^-?[0-9]+$' && [ "$runtime_s" != "-1" ] && [ "$runtime_s" -gt 0 ]; then
        runtime_valid=true
    fi

    if $baseline_valid && $actual_valid; then
        genie_power=$(echo "$actual_power $baseline_power" | awk '{printf "%.3f", $1 - $2}')
        log_info "计算净功耗: $actual_power - $baseline_power = $genie_power mAh"
    else
        log_info "无法计算净功耗 - 基线有效: $baseline_valid, 实际有效: $actual_valid"
    fi

    if $runtime_valid && echo "$genie_power" | grep -qE '^-?[0-9]+\.?[0-9]*$' && [ "$genie_power" != "-1.0" ]; then
        avg_power=$(echo "$genie_power $runtime_s" | awk '{printf "%.3f", $1 / $2}')
        log_info "计算平均功耗: $genie_power / $runtime_s = $avg_power mA"
    else
        log_info "无法计算平均功耗 - 运行时间有效: $runtime_valid, 净功耗: $genie_power"
    fi

    # 分析内存数据
    local memory_stats
    memory_stats=$(analyze_memory_data "memory_logs/system_memory.log")

    # 统计推理进程数量
    local process_count=0
    if [ -f "power_logs/all_pids.txt" ]; then
        process_count=$(wc -l < "power_logs/all_pids.txt")
    fi

    # 统计完成的题目数量
    local completed_questions=0
    for subject_file in result/temp/*_answers.txt; do
        if [ -f "$subject_file" ]; then
            local subject_questions
            subject_questions=$(grep -c "ANSWER_START" "$subject_file" 2>/dev/null || echo 0)
            completed_questions=$((completed_questions + subject_questions))
        fi
    done 2>/dev/null || true

    # 预计算复杂的awk值
    local power_per_inference="-1.0"
    if echo "$genie_power" | grep -qE '^-?[0-9]+\.?[0-9]*$' && [ "$genie_power" != "-1.0" ] && [ $process_count -gt 0 ]; then
        power_per_inference=$(echo "$genie_power $process_count" | awk '{printf "%.6f", $1 / $2}')
        log_info "计算每次推理功耗: $genie_power / $process_count = $power_per_inference mAh"
    else
        log_info "无法计算每次推理功耗 - 净功耗: $genie_power, 进程数: $process_count"
    fi

    local avg_time_per_question="-1"
    if [ $completed_questions -gt 0 ] && echo "$runtime_ms" | grep -qE '^-?[0-9]+$' && [ "$runtime_ms" != "-1" ]; then
        avg_time_per_question=$(echo "$runtime_ms $completed_questions" | awk '{printf "%.0f", $1 / $2}')
        log_info "计算每题平均时间: $runtime_ms / $completed_questions = $avg_time_per_question ms"
    else
        log_info "无法计算每题平均时间 - 运行时间: $runtime_ms, 完成题目数: $completed_questions"
    fi

    # 从日志文件中提取基线测试数据
    local baseline_duration_s=-1
    local baseline_power_from_log=-1.0

    if [ -f "$POWER_LOG_FILE" ]; then
        # 提取基线时长，确保只获取数值部分
        baseline_duration_s=$(grep "BASELINE_TEST_DURATION_S=" "$POWER_LOG_FILE" | tail -1 | cut -d'=' -f2 | tr -d ' \n\r' || echo "-1")
        # 验证并转换为数字
        if ! echo "$baseline_duration_s" | grep -qE '^[0-9]+$'; then
            baseline_duration_s="-1"
            log_info "基线时长数据无效，设置为 -1"
        fi

        # 提取基线功耗
        baseline_power_from_log=$(grep "BASELINE_POWER_MAH=" "$POWER_LOG_FILE" | tail -1 | cut -d'=' -f2 | tr -d ' \n\r' || echo "-1.0")
        # 验证并转换为数字
        if ! echo "$baseline_power_from_log" | grep -qE '^[0-9]+\.?[0-9]*$'; then
            baseline_power_from_log="-1.0"
            log_info "基线功耗数据无效，设置为 -1.0"
        fi

        log_info "从日志提取 - 基线时长: ${baseline_duration_s}s, 基线功耗: ${baseline_power_from_log}mAh"
    else
        log_info "日志文件不存在，基线数据设置为 -1"
    fi

    # 生成JSON报告
    local timestamp
    timestamp=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')

    # 确保所有数值变量都是有效的
    local safe_baseline_power=${baseline_power_from_log:-"-1.0"}
    local safe_actual_power=${actual_power:-"-1.0"}
    local safe_runtime_ms=${runtime_ms:-"-1"}
    local safe_runtime_s=${runtime_s:-"-1"}
    local safe_baseline_duration_s=${baseline_duration_s:-"-1"}
    local safe_genie_power=${genie_power:-"-1.0"}
    local safe_avg_power=${avg_power:-"-1.0"}
    local safe_power_per_inference=${power_per_inference:-"-1.0"}
    local safe_avg_time_per_question=${avg_time_per_question:-"-1"}

    # 验证和清理所有数值
    for var in safe_baseline_power safe_actual_power safe_genie_power safe_avg_power safe_power_per_inference; do
        local value=$(eval echo \$$var)
        if ! echo "$value" | grep -qE '^-?[0-9]+\.?[0-9]*$'; then
            eval "$var=\"-1.0\""
            log_info "变量 $var 的值($value)无效，设置为 -1.0"
        fi
    done

    for var in safe_runtime_ms safe_runtime_s safe_baseline_duration_s safe_avg_time_per_question; do
        local value=$(eval echo \$$var)
        if ! echo "$value" | grep -qE '^-?[0-9]+$'; then
            eval "$var=\"-1\""
            log_info "变量 $var 的值($value)无效，设置为 -1"
        fi
    done

    cat > "$FINAL_REPORT_FILE" << EOF
{
  "test_summary": {
    "test_start_time": "$timestamp",
    "baseline_test": {
      "power_consumption_mah": $safe_baseline_power,
      "duration_s": $safe_baseline_duration_s
    },
    "actual_test": {
      "power_consumption_mah": $safe_actual_power,
      "duration_ms": $safe_runtime_ms,
      "duration_s": $safe_runtime_s
    },
    "genie_net_power": {
      "consumption_mah": $safe_genie_power,
      "average_power_ma": $safe_avg_power,
      "power_per_inference_mah": $safe_power_per_inference
    }
  },
  "performance_metrics": {
    "total_genie_processes": $process_count,
    "completed_questions": $completed_questions,
    "average_time_per_question_ms": $safe_avg_time_per_question
  },
  $(echo "$memory_stats" | sed '1d;$d'),
  "test_environment": {
    "device_info": "$(getprop ro.product.model 2>/dev/null || echo 'Unknown')",
    "android_version": "$(getprop ro.build.version.release 2>/dev/null || echo 'Unknown')"
  },
  "generated_at": "$timestamp"
}
EOF

    log_info "最终报告已生成: $FINAL_REPORT_FILE"

    # 输出关键结果
    echo "=== 测试结果摘要 ==="
    echo "基线功耗: ${baseline_power} mAh"
    echo "实际功耗: ${actual_power} mAh"
    echo "Genie净功耗: ${genie_power} mAh"
    echo "平均功耗: ${avg_power} mA"
    echo "推理进程数: $process_count"
    echo "完成题目数: $completed_questions"
    echo "详细报告: $FINAL_REPORT_FILE"
}

# 主函数
main() {
    log_info "=== 开始两阶段功耗测试 ==="

    # 设置环境
    setup_test_environment

    # Phase 1: 实际测试
    local actual_test_result=$(run_actual_test)
    local actual_power=$(echo "$actual_test_result" | awk '{print $1}')
    local runtime_ms=$(echo "$actual_test_result" | awk '{print $2}')
    local runtime_s=$(echo "$actual_test_result" | awk '{print $3}')

    # Phase 2: 基线测试
    if [ "$runtime_s" -gt 0 ]; then
        log_info "开始基线测试，时长: $runtime_s 秒"
        local baseline_power
        baseline_power=$(run_baseline_test "$runtime_s")
    else
        log_error "实际测试时长无效(runtime_s=$runtime_s)，无法进行基线测试"
        baseline_power="-1.0"
    fi

    # 生成最终报告
    generate_final_report "$baseline_power" "$actual_power" "$runtime_ms" "$runtime_s"

    # 恢复环境
    restore_environment

    log_info "=== 两阶段功耗测试完成 ==="
}

# 错误处理
trap 'log_error "测试被中断"; restore_environment; exit 1' INT TERM

# 执行主函数
main "$@"